<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETX输入工具</title>
    <script src="./vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 浅色主题 */
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', '微软雅黑', 'SimHei', '黑体', 'Source Han Sans CN', '思源黑体', -apple-system, BlinkMacSystemFont, sans-serif;
            background:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"),
                linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%);
            background-blend-mode: overlay;
            color: #1a1a1a;
            border-radius: 0;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 8px 16px rgba(0, 0, 0, 0.08),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            overflow: hidden;
            user-select: none;
            backdrop-filter: blur(20px);
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }

        /* 深色主题 */
        body.dark-theme {
            background:
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"),
                linear-gradient(135deg, rgba(30, 30, 30, 0.98) 0%, rgba(45, 45, 45, 0.98) 100%);
            background-blend-mode: overlay;
            color: #f0f0f0;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            padding: 0;
        }

        html {
            border-radius: 0;
            overflow: hidden;
        }

        #app {
            padding: 4px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .input-field {
            flex: 1;
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 0;
            padding: 4px 10px;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
            background: rgba(255, 255, 255, 0.8);
            color: #1a1a1a;
            font-family: 'PingFang SC', 'Microsoft YaHei', '微软雅黑', 'SimHei', '黑体', 'Source Han Sans CN', '思源黑体', -apple-system, BlinkMacSystemFont, sans-serif;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.05) inset,
                0 1px 2px rgba(0, 0, 0, 0.03);
            font-weight: 400;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-field:focus {
            border-color: rgba(59, 130, 246, 0.6);
            background: rgba(255, 255, 255, 0.95);
            box-shadow:
                0 0 0 2.7px rgba(59, 130, 246, 0.25),
                0 0 16px rgba(59, 130, 246, 0.2),
                0 4px 12px rgba(0, 0, 0, 0.05) inset,
                0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .input-field::placeholder {
            color: #999;
            opacity: 0.8;
        }

        /* 深色主题输入框 */
        body.dark-theme .input-field {
            background: rgba(50, 50, 50, 0.8);
            color: #f0f0f0;
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.3) inset,
                0 1px 2px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-theme .input-field:focus {
            background: rgba(60, 60, 60, 0.95);
            border-color: rgba(96, 165, 250, 0.6);
            box-shadow:
                0 0 0 2.7px rgba(96, 165, 250, 0.25),
                0 0 16px rgba(96, 165, 250, 0.2),
                0 4px 12px rgba(0, 0, 0, 0.3) inset,
                0 1px 2px rgba(0, 0, 0, 0.2);
        }

        body.dark-theme .input-field::placeholder {
            color: #888;
        }
        
        /* 粘贴方式选择框 */
        .paste-method-selector {
            position: absolute;
            bottom: 6px;
            right: 6px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0;
            padding: 3px 4px;
            font-size: 11px;
            color: #333;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            outline: none;
            line-height: 1.4;
        }

        body.dark-theme .paste-method-selector {
            background: rgba(60, 60, 60, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* 复制按钮 */
        .copy-button {
            position: absolute;
            bottom: 6px;
            right: 110px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0;
            padding: 3px 6px;
            font-size: 11px;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            outline: none;
            transition: all 0.2s ease;
            line-height: 1.4;
        }

        .copy-button:hover {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .copy-button:active {
            background: rgba(255, 255, 255, 0.95);
            transform: scale(0.98);
        }

        body.dark-theme .copy-button {
            background: rgba(60, 60, 60, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-theme .copy-button:hover {
            background: rgba(70, 70, 80, 0.85);
            border-color: rgba(96, 165, 250, 0.4);
        }

        /* 复制成功提示 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        body.dark-theme .toast {
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
        }
        
        .paste-method-selector:focus {
            border-color: rgba(59, 130, 246, 0.6);
        }
        
        body.dark-theme .paste-method-selector:focus {
            border-color: rgba(96, 165, 250, 0.6);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="input-container">
            <textarea
                class="input-field"
                v-model="inputText"
                @keydown="handleKeyDown"
                ref="inputField"
                placeholder="输入内容后，按回车发送 | Ctrl+↑↓ 浏览历史记录"
                autofocus
            ></textarea>
            <button
                class="copy-button"
                @click="copyToClipboard"
                title="复制到剪贴板"
            >复制</button>
            <select
                class="paste-method-selector"
                v-model="selectedPasteMethod"
                @change="savePasteMethodPreference"
                ref="pasteMethodSelector"
            >
                <option value="middleClick">鼠标中键</option>
                <option value="ctrlV">Ctrl+V</option>
                <option value="ctrlShiftV">Ctrl+Shift+V</option>
            </select>
        </div>
        <div class="toast" :class="{ show: showToast }">复制成功</div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    inputText: '',
                    currentTheme: 'light',
                    history: [],
                    historyIndex: -1,
                    tempInputText: '', // 保存用户当前输入的内容
                    selectedPasteMethod: 'ctrlShiftV', // 默认粘贴方式
                    showToast: false // 控制提示显示
                };
            },
            async mounted() {
                // 清空输入内容
                this.inputText = '';

                // 自动聚焦到输入框
                this.$refs.inputField.focus();

                // 加载配置并应用主题
                try {
                    const config = await window.electronAPI.getConfig();
                    this.currentTheme = config.theme || 'light';
                    this.selectedPasteMethod = config.pasteMethod || 'middleClick';
                    this.applyTheme();
                } catch (error) {
                    console.error('加载配置失败:', error);
                }

                // 加载历史记录
                try {
                    this.history = await window.electronAPI.getHistory();
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                    this.history = [];
                }

                // 监听主题更新
                if (window.electronAPI && window.electronAPI.onThemeUpdated) {
                    window.electronAPI.onThemeUpdated((theme) => {
                        this.updateTheme(theme);
                    });
                }

                // 监听清空输入区的通知
                if (window.electronAPI && window.electronAPI.onClearInput) {
                    window.electronAPI.onClearInput(() => {
                        this.inputText = '';
                        this.historyIndex = -1;
                        this.tempInputText = '';
                    });
                }

                // 监听历史记录重新加载通知
                if (window.electronAPI && window.electronAPI.onHistoryReload) {
                    window.electronAPI.onHistoryReload(async () => {
                        try {
                            this.history = await window.electronAPI.getHistory();
                            this.historyIndex = -1;
                            this.tempInputText = '';
                            console.log('历史记录已重新加载，共', this.history.length, '条');
                        } catch (error) {
                            console.error('重新加载历史记录失败:', error);
                        }
                    });
                }
            },
            methods: {
                applyTheme() {
                    const body = document.body;
                    if (this.currentTheme === 'dark') {
                        body.classList.add('dark-theme');
                    } else {
                        body.classList.remove('dark-theme');
                    }
                },

                updateTheme(newTheme) {
                    this.currentTheme = newTheme;
                    this.applyTheme();
                },
                
                async savePasteMethodPreference() {
                    try {
                        const config = await window.electronAPI.getConfig();
                        config.pasteMethod = this.selectedPasteMethod;
                        await window.electronAPI.saveConfig(config);
                        console.log('粘贴方式偏好已保存:', this.selectedPasteMethod);
                    } catch (error) {
                        console.error('保存粘贴方式偏好失败:', error);
                    }
                },
                
                async sendText() {
                    if (this.inputText.trim()) {
                        try {
                            // 传递文本和粘贴方式
                            await window.electronAPI.sendText({
                                text: this.inputText.trim(),
                                pasteMethod: this.selectedPasteMethod
                            });
                            // 发送成功后立即清空输入区
                            this.inputText = '';
                            this.historyIndex = -1;
                            this.tempInputText = '';
                        } catch (error) {
                            console.error('发送文本失败:', error);
                        }
                    }
                },

                navigateHistory(direction) {
                    if (this.history.length === 0) return;

                    // 如果是第一次按Ctrl+上箭头，保存当前输入内容
                    if (this.historyIndex === -1) {
                        this.tempInputText = this.inputText;
                    }

                    // 计算新的历史记录索引
                    let newIndex;
                    if (direction === 1) {
                        // Ctrl+上箭头：显示更新的历史记录（从最新开始）
                        if (this.historyIndex === -1) {
                            newIndex = 0; // 从最新的历史记录开始（索引0）
                        } else if (this.historyIndex < this.history.length - 1) {
                            newIndex = this.historyIndex + 1; // 移动到下一条（更旧的）
                        } else {
                            newIndex = this.historyIndex; // 已经是最旧的，保持不变
                        }
                    } else {
                        // Ctrl+下箭头：回到更新的记录或用户输入
                        if (this.historyIndex > 0) {
                            newIndex = this.historyIndex - 1; // 移动到上一条（更新的）
                        } else {
                            newIndex = -1; // 回到用户输入
                        }
                    }

                    this.historyIndex = newIndex;

                    // 更新输入框内容
                    if (this.historyIndex === -1) {
                        // 回到用户输入的内容
                        this.inputText = this.tempInputText;
                    } else {
                        // 显示历史记录
                        this.inputText = this.history[this.historyIndex];
                    }

                    console.log('历史记录导航:', {
                        direction: direction === 1 ? '上' : '下',
                        newIndex: this.historyIndex,
                        content: this.historyIndex === -1 ? '用户输入' : this.history[this.historyIndex]
                    });
                },

                handleKeyDown(event) {
                    if (event.key === 'Enter') {
                        // 阻止默认的换行行为
                        event.preventDefault();
                        this.sendText();
                    } else if (event.key === 'Escape') {
                        this.closeWindow();
                    } else if (event.ctrlKey && event.key === 'ArrowUp') {
                        // Ctrl + 上箭头：切换到更新的历史记录（向后浏览）
                        event.preventDefault();
                        this.navigateHistory(1);
                    } else if (event.ctrlKey && event.key === 'ArrowDown') {
                        // Ctrl + 下箭头：切换到更旧的历史记录（向前浏览）
                        event.preventDefault();
                        this.navigateHistory(-1);
                    } else if (!event.ctrlKey) {
                        // 用户开始输入新的内容时，重置历史记录索引
                        this.historyIndex = -1;
                        this.tempInputText = '';
                    }
                },

                closeWindow() {
                    window.electronAPI.hideInputWindow();
                },

                async copyToClipboard() {
                    if (this.inputText.trim()) {
                        try {
                            await navigator.clipboard.writeText(this.inputText.trim());
                            console.log('已复制到剪贴板:', this.inputText.trim());
                            // 显示提示
                            this.showToast = true;
                            setTimeout(() => {
                                this.showToast = false;
                            }, 1000);
                        } catch (error) {
                            console.error('复制失败:', error);
                        }
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
